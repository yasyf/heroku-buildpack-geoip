#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3
VENDOR_DIR="vendor"

GEOLITECITY_FILE="GeoLite2-City.mmdb"
GEOLITECITY_URL="http://geolite.maxmind.com/download/geoip/database/$GEOLITECITY_FILE.gz"

mkdir -p $CACHE_DIR/geoip
cd $CACHE_DIR/geoip

echo "-----> Installing libmaxminddb $VERSION"
add-apt-repository ppa:maxmind/ppa
apt-get update
apt-get install libmaxminddb0 libmaxminddb-dev mmdb-bin

echo "-----> Fetching $GEOLITECITY_FILE"

if [ ! -f $GEOLITECITY_FILE ]; then
  curl -s -L -o ${GEOLITECITY_FILE}.gz $GEOLITECITY_URL
  gunzip ${GEOLITECITY_FILE}.gz > /dev/null
else
  echo "$GEOLITECITY_FILE already cached"
fi

mkdir -p $VENDOR_DIR/geoip
cd $VENDOR_DIR/geoip

cp $CACHE_DIR/geoip/$GEOLITECITY_FILE .
GEOIP_DB_PATH="/app/$VENDOR_DIR/geoip/$GEOLITECITY_FILE"

PROFILE_PATH="$BUILD_DIR/.profile.d/geoip.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "export GEOIP_DB_PATH=\"$GEOIP_DB_PATH\"" >> $PROFILE_PATH
